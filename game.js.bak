const { useState, useEffect, useRef, useCallback } = React;

// --- ì•„ì´ì½˜ ì»´í¬ë„ŒíŠ¸ ---
const IconBase = ({ children, size = 24, className = "", onClick, title }) => (
    <svg onClick={onClick} title={title} xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className} style={{ cursor: onClick ? 'pointer' : 'inherit' }}>{children}</svg>
);

const Icons = {
    User: (p) => <IconBase {...p}><path d="M19 21v-2a4 4 0 0 0-4-4H9a4 4 0 0 0-4 4v2" /><circle cx="12" cy="7" r="4" /></IconBase>,
    Hammer: (p) => <IconBase {...p}><path d="m15 12-8.5 8.5c-.83.83-2.17.83-3 0 0-.83 0-2.17.83-3L12 9" /><path d="M17.64 15 22 10.64" /><path d="m20.91 11.7-1.25-1.25c-.6-.6-.93-1.4-.93-2.25V7.86c0-.55-.45-1-1-1H14.14c-.83 0-1.64.32-2.25.92L9.64 10" /></IconBase>,
    BrainCircuit: (p) => <IconBase {...p}><path d="M12 4.5a2.5 2.5 0 0 0-4.96-.46 2.5 2.5 0 0 0-1.98 3 2.5 2.5 0 0 0-1.32 4.24 3 3 0 0 0 .34 5.58 2.5 2.5 0 0 0 2.96 3.08 2.5 2.5 0 0 0 4.91.05L12 20V4.5Z" /><path d="M16 8V5c0-1.1.9-2 2-2" /><path d="M12 13h4" /><path d="M12 18h6a2 2 0 0 1 2 2v1" /><path d="M12 8h8" /></IconBase>,
    Pickaxe: (p) => <IconBase {...p}><path d="M14.5 5.5C18.5 9.5 20 12 20 12l-4 4-2-2-4 4-5.5-5.5 4-4-2-2 4-4Z" /><path d="m2.5 21.5 9-9" /></IconBase>,
    Scroll: (p) => <IconBase {...p}><path d="M8 19V5c0-1.1.9-2 2-2h4a2 2 0 0 1 2 2v1" /><path d="M8 19a2 2 0 1 0 0-4h12V4.5a2.5 2.5 0 0 0-5 0V5" /><path d="M10 22h8a2 2 0 0 0 2-2v-1" /></IconBase>,
    Zap: (p) => <IconBase {...p}><polygon points="13 2 3 14 12 14 11 22 21 10 12 10 13 2" /></IconBase>,
    Rocket: (p) => <IconBase {...p}><path d="M4.5 16.5c-1.5 1.26-2 5-2 5s3.74-.5 5-2c.71-.84.7-2.13-.09-2.91a2.18 2.18 0 0 0-2.91-.09z" /><path d="m12 15-3-3a22 22 0 0 1 2-5.25 22 22 0 0 1 5.35-5.35A22 22 0 0 1 17 9a22 22 0 0 1-5 6z" /><path d="M9 22c5 1 10-2.5 11-8.89a6 6 0 0 0-1.07-1.07 4 4 0 0 0-1.08-1.08" /></IconBase>,
    FlaskConical: (p) => <IconBase {...p}><path d="M10 2v7.527a2 2 0 0 1-.211.896L4.72 20.55a1 1 0 0 0 .9 1.45h12.76a1 1 0 0 0 .9-1.45l-5.069-10.127A2 2 0 0 1 14 9.527V2" /><path d="M8.5 2h7" /><path d="M7 16h10" /></IconBase>,
    Wheat: (p) => <IconBase {...p}><path d="M2 22 16 8" /><path d="M3.47 12.53 5 11l1.53 1.53a3.5 3.5 0 0 1 0 4.94L5 19l-1.53-1.53a3.5 3.5 0 0 1 0-4.94Z" /><path d="M7.47 8.53 9 7l1.53 1.53a3.5 3.5 0 0 1 0 4.94L9 15l-1.53-1.53a3.5 3.5 0 0 1 0-4.94Z" /><path d="M11.47 4.53 13 3l1.53 1.53a3.5 3.5 0 0 1 0 4.94L13 11l-1.53-1.53a3.5 3.5 0 0 1 0-4.94Z" /><path d="M20 2h2v2a4 4 0 0 1-4 4h-2V6a4 4 0 0 1 4-4Z" /></IconBase>,
    Shield: (p) => <IconBase {...p}><path d="M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10z" /></IconBase>,
    Star: (p) => <IconBase {...p}><polygon points="12 2 15.09 8.26 22 9.27 17 14.14 18.18 21.02 12 17.77 5.82 21.02 7 14.14 2 9.27 8.91 8.26 12 2" /></IconBase>,
    Globe: (p) => <IconBase {...p}><circle cx="12" cy="12" r="10" /><line x1="2" x2="22" y1="12" y2="12" /><path d="M12 2a15.3 15.3 0 0 1 4 10 15.3 15.3 0 0 1-4 10 15.3 15.3 0 0 1-4 10 15.3 15.3 0 0 1 4-10z" /></IconBase>,
    Volume2: (p) => <IconBase {...p}><polygon points="11 5 6 9 2 9 2 15 6 15 11 19 11 5" /><path d="M19.07 4.93a10 10 0 0 1 0 14.14" /><path d="M15.54 8.46a5 5 0 0 1 0 7.07" /></IconBase>,
    VolumeX: (p) => <IconBase {...p}><polygon points="11 5 6 9 2 9 2 15 6 15 11 19 11 5" /><line x1="23" x2="17" y1="9" y2="15" /><line x1="17" x2="23" y1="9" y2="15" /></IconBase>,
    Crown: (p) => <IconBase {...p}><path d="m2 4 3 12h14l3-12-6 7-4-7-4 7-6-7zm3 16h14" /></IconBase>,
    Save: (p) => <IconBase {...p}><path d="M19 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11l5 5v11a2 2 0 0 1-2 2z" /><polyline points="17 21 17 13 7 13 7 21" /><polyline points="7 3 7 8 15 8" /></IconBase>,
    RotateCcw: (p) => <IconBase {...p}><path d="M3 12a9 9 0 1 0 9-9 9.75 9.75 0 0 0-6.74 2.74L3 8" /><path d="M3 3v5h5" /></IconBase>,
    Trash: (p) => <IconBase {...p}><polyline points="3 6 5 6 21 6" /><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2" /></IconBase>,
    Home: (p) => <IconBase {...p}><path d="M3 9l9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z" /><polyline points="9 22 9 12 15 12 15 22" /></IconBase>,
    X: (p) => <IconBase {...p}><path d="M18 6 6 18" /><path d="m6 6 12 12" /></IconBase>,
    FilePlus: (p) => <IconBase {...p}><path d="M14.5 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V7.5L14.5 2z" /><polyline points="14 2 14 8 20 8" /><line x1="12" x2="12" y1="18" y2="12" /><line x1="9" x2="15" y1="15" y2="15" /></IconBase>,
    Flame: (p) => <IconBase {...p}><path d="M8.5 14.5A2.5 2.5 0 0 0 11 12c0-1.38-.5-2-1-3-1.072-2.143-.224-4.054 2-6 .5 2.5 2 4.9 4 6.5 2 1.6 3 3.5 3 5.5a7 7 0 1 1-14 0c0-1.1.2-2.2.6-3.268" /></IconBase>,
    Maximize: (p) => <IconBase {...p}><path d="M8 3H5a2 2 0 0 0-2 2v3m18 0V5a2 2 0 0 0-2-2h-3m0 18h3a2 2 0 0 0 2-2v-3M3 16v3a2 2 0 0 0 2 2h3" /></IconBase>,
    Minimize: (p) => <IconBase {...p}><path d="M8 3v3a2 2 0 0 1-2 2H3m18 0h-3a2 2 0 0 1-2-2V3m0 18v-3a2 2 0 0 1 2-2h3M3 16h3a2 2 0 0 1 2 2v3" /></IconBase>,
    ArrowUp: (p) => <IconBase {...p}><line x1="12" x2="12" y1="19" y2="5" /><polyline points="5 12 12 5 19 12" /></IconBase>,
    Wrench: (p) => <IconBase {...p}><path d="M14.7 6.3a1 1 0 0 0 0 1.4l1.6 1.6a1 1 0 0 0 1.4 0l3.77-3.77a6 6 0 0 1-7.94 7.94l-6.91 6.91a2.12 2.12 0 0 1-3-3l6.91-6.91a6 6 0 0 1 7.94-7.94l-3.76 3.76z" /></IconBase>
};

const { Pickaxe, Scroll, Zap, User, Rocket, FlaskConical, Hammer, Wheat, BrainCircuit, Shield, Star, Globe, Volume2, VolumeX, Crown, Save, RotateCcw, Trash, Home, X, FilePlus, Flame, Maximize, Minimize, ArrowUp, Wrench } = Icons;

// --- ì‚¬ìš´ë“œ ë§¤ë‹ˆì € ---
const useSound = () => {
    const audioCtxRef = useRef(null);
    const [isMuted, setIsMuted] = useState(false);
    const [isInit, setIsInit] = useState(false);

    const initAudio = () => {
        if (isInit) return;
        const AudioContext = window.AudioContext || window.webkitAudioContext;
        if (!AudioContext) return;
        audioCtxRef.current = new AudioContext();
        setIsInit(true);
    };

    const playSound = useCallback((type) => {
        if (isMuted || !audioCtxRef.current) return;
        const ctx = audioCtxRef.current;
        if (ctx.state === 'suspended') ctx.resume();
        const osc = ctx.createOscillator();
        const gainNode = ctx.createGain();
        osc.connect(gainNode);
        gainNode.connect(ctx.destination);
        const now = ctx.currentTime;

        if (type === 'click') {
            osc.type = 'sine'; osc.frequency.setValueAtTime(600, now); osc.frequency.exponentialRampToValueAtTime(300, now + 0.1);
            gainNode.gain.setValueAtTime(0.05, now); gainNode.gain.exponentialRampToValueAtTime(0.001, now + 0.1);
            osc.start(now); osc.stop(now + 0.1);
        } else if (type === 'build') {
            osc.type = 'square'; osc.frequency.setValueAtTime(150, now); osc.frequency.linearRampToValueAtTime(100, now + 0.15);
            gainNode.gain.setValueAtTime(0.05, now); gainNode.gain.linearRampToValueAtTime(0.001, now + 0.15);
            osc.start(now); osc.stop(now + 0.15);
        } else if (type === 'upgrade') {
            osc.type = 'triangle'; osc.frequency.setValueAtTime(440, now); osc.frequency.linearRampToValueAtTime(880, now + 0.2);
            gainNode.gain.setValueAtTime(0.05, now); gainNode.gain.linearRampToValueAtTime(0.001, now + 0.2);
            osc.start(now); osc.stop(now + 0.2);
        } else if (type === 'research') {
            osc.type = 'triangle'; osc.frequency.setValueAtTime(523.25, now); osc.frequency.setValueAtTime(659.25, now + 0.1); osc.frequency.setValueAtTime(783.99, now + 0.2);
            gainNode.gain.setValueAtTime(0.05, now); gainNode.gain.linearRampToValueAtTime(0.05, now + 0.2); gainNode.gain.exponentialRampToValueAtTime(0.001, now + 0.4);
            osc.start(now); osc.stop(now + 0.4);
        } else if (type === 'age') {
            osc.type = 'sawtooth'; osc.frequency.setValueAtTime(220, now); osc.frequency.linearRampToValueAtTime(880, now + 1.5);
            gainNode.gain.setValueAtTime(0.05, now); gainNode.gain.linearRampToValueAtTime(0.1, now + 1.0); gainNode.gain.linearRampToValueAtTime(0.001, now + 2.0);
            osc.start(now); osc.stop(now + 2.0);
        } else if (type === 'wonder') {
            osc.type = 'sine'; osc.frequency.setValueAtTime(261.63, now); osc.frequency.exponentialRampToValueAtTime(523.25, now + 2);
            const osc2 = ctx.createOscillator(); const gain2 = ctx.createGain(); osc2.connect(gain2); gain2.connect(ctx.destination);
            osc2.type = 'triangle'; osc2.frequency.setValueAtTime(329.63, now); osc2.frequency.exponentialRampToValueAtTime(659.25, now + 2);
            gainNode.gain.setValueAtTime(0.1, now); gainNode.gain.linearRampToValueAtTime(0, now + 2.5);
            gain2.gain.setValueAtTime(0.1, now); gain2.gain.linearRampToValueAtTime(0, now + 2.5);
            osc.start(now); osc.stop(now + 2.5); osc2.start(now); osc2.stop(now + 2.5);
        } else if (type === 'disaster') {
            osc.type = 'sawtooth'; osc.frequency.setValueAtTime(100, now); osc.frequency.linearRampToValueAtTime(50, now + 0.5);
            gainNode.gain.setValueAtTime(0.1, now); gainNode.gain.linearRampToValueAtTime(0.001, now + 0.5);
            osc.start(now); osc.stop(now + 0.5);
        } else if (type === 'error') {
            osc.type = 'sawtooth'; osc.frequency.setValueAtTime(150, now); osc.frequency.linearRampToValueAtTime(100, now + 0.1);
            gainNode.gain.setValueAtTime(0.05, now); gainNode.gain.linearRampToValueAtTime(0.001, now + 0.1);
            osc.start(now); osc.stop(now + 0.1);
        }
    }, [isMuted, isInit]);
    const toggleMute = () => setIsMuted(!isMuted);
    return { initAudio, playSound, isMuted, toggleMute };
};

// --- ê²Œì„ ë°ì´í„° ---
const RACES = [
    { id: 'human', name: 'í˜¸ëª¨ ì‚¬í”¼ì—”ìŠ¤', desc: 'ê· í˜• ì¡íŒ ëŠ¥ë ¥', bonus: { food: 1.0, prod: 1.0, sci: 1.0 }, icon: <User size={48} /> },
    { id: 'neanderthal', name: 'ë„¤ì•ˆë°ë¥´íƒˆì¸', desc: 'ë†’ì€ ìƒì‚°ë ¥, ë‚®ì€ ì—°êµ¬', bonus: { food: 0.9, prod: 1.5, sci: 0.7 }, icon: <Hammer size={48} /> },
    { id: 'atlantean', name: 'ì•„í‹€ë€í‹°ìŠ¤ì¸', desc: 'ë†’ì€ ì§€ëŠ¥, ë§ì€ ì‹ëŸ‰ ì†Œëª¨', bonus: { food: 0.7, prod: 0.8, sci: 1.5 }, icon: <BrainCircuit size={48} /> }
];

const DISASTERS_BY_AGE = {
    0: [{ name: 'ëŒ€ê°€ë­„', type: 'resource', target: 'food', ratio: 0.3, desc: 'ê°€ë­„ìœ¼ë¡œ ì‹ëŸ‰ 30%ê°€ ìœ ì‹¤ë˜ì—ˆìŠµë‹ˆë‹¤!' }, { name: 'ì‚°ë¶ˆ', type: 'building', target: 'farm', count: 1, desc: 'ì‚°ë¶ˆì´ ë²ˆì ¸ ì±„ì§‘ì§€ 1ê³³ì´ ë¶ˆíƒ”ìŠµë‹ˆë‹¤!' }],
    1: [{ name: 'ëŒ€í™ìˆ˜', type: 'resource', target: 'food', ratio: 0.4, desc: 'í™ìˆ˜ë¡œ ì‹ëŸ‰ 40%ê°€ ë– ë‚´ë ¤ê°”ìŠµë‹ˆë‹¤!' }, { name: 'ì§€ì§„', type: 'building', target: 'mine', count: 1, desc: 'ì§€ì§„ìœ¼ë¡œ ê´‘ì‚° 1ê³³ì´ ë¬´ë„ˆì¡ŒìŠµë‹ˆë‹¤!' }],
    2: [{ name: 'í‘ì‚¬ë³‘', type: 'resource', target: 'food', ratio: 0.5, desc: 'ì—­ë³‘ìœ¼ë¡œ ì‹ëŸ‰ ìƒì‚°ì´ 50% ê¸‰ê°í–ˆìŠµë‹ˆë‹¤!' }, { name: 'ì „ìŸ', type: 'resource', target: 'prod', ratio: 0.4, desc: 'ì „ìŸ ë°œë°œ! ìƒì‚° ë¬¼ì 40%ê°€ ì§•ë°œë˜ì—ˆìŠµë‹ˆë‹¤.' }],
    3: [{ name: 'ê³µì¥ í™”ì¬', type: 'building', target: 'mine', count: 2, desc: 'ëŒ€í˜• í™”ì¬ë¡œ ê³µì¥ 2ê³³ì´ ì „ì†Œë˜ì—ˆìŠµë‹ˆë‹¤!' }, { name: 'ê²½ì œ ëŒ€ê³µí™©', type: 'resource', target: 'prod', ratio: 0.5, desc: 'ëŒ€ê³µí™©ìœ¼ë¡œ ìƒì‚°ë ¥ì´ 50% ê°ì†Œí–ˆìŠµë‹ˆë‹¤.' }],
    4: [{ name: 'ê¸ˆìœµ ìœ„ê¸°', type: 'resource', target: 'prod', ratio: 0.6, desc: 'ê¸ˆìœµ ìœ„ê¸°ë¡œ ìƒì‚° ìê¸ˆ 60%ê°€ ì¦ë°œí–ˆìŠµë‹ˆë‹¤.' }, { name: 'ì‚¬ì´ë²„ í…ŒëŸ¬', type: 'resource', target: 'sci', ratio: 0.4, desc: 'í•´í‚¹ìœ¼ë¡œ ì—°êµ¬ ë°ì´í„° 40%ê°€ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤.' }],
    5: [{ name: 'íƒœì–‘ í‘ì  í­ë°œ', type: 'resource', target: 'sci', ratio: 0.8, desc: 'ê°•ë ¥í•œ ìê¸°ì¥ìœ¼ë¡œ ì—°êµ¬ ë°ì´í„° 80% ì†ì‹¤!' }, { name: 'ì†Œí–‰ì„± ì¶©ëŒ', type: 'building_all', count: 1, desc: 'ì†Œí–‰ì„± íŒŒí¸ì´ ë–¨ì–´ì ¸ ëª¨ë“  ì¢…ë¥˜ì˜ ê±´ë¬¼ì´ 1ê°œì”© íŒŒê´´ë˜ì—ˆìŠµë‹ˆë‹¤!' }]
};

const WONDERS = {
    human: { name: 'ëŒ€í”¼ë¼ë¯¸ë“œ', desc: 'ìœ„ëŒ€í•œ ìœ ì‚°: ëª¨ë“  ìì› ìƒì‚°ëŸ‰ +50%', cost: { food: 1000, prod: 1000, sci: 500 }, effect: 'all_boost' },
    neanderthal: { name: 'ê±°ì¸ì˜ ì œë‹¨', desc: 'ê³ ëŒ€ì˜ í˜: ìƒì‚°ë ¥ íšë“ëŸ‰ 3ë°°', cost: { food: 500, prod: 2000, sci: 0 }, effect: 'prod_boost' },
    atlantean: { name: 'ì‹¬í•´ì˜ ìˆ˜ì •íƒ‘', desc: 'ìƒì–´ë²„ë¦° ê¸°ìˆ : ê³¼í•™ íšë“ëŸ‰ 2ë°°', cost: { food: 2000, prod: 500, sci: 2000 }, effect: 'sci_boost' }
};

const AGES = [
    { id: 0, name: 'ì›ì‹œ ì‹œëŒ€', color: 'age-stone', img: 'https://images.unsplash.com/photo-1518176258769-e3d62283dc15?auto=format&fit=crop&w=1600&q=80' },
    { id: 1, name: 'ê³ ëŒ€ ì‹œëŒ€', color: 'age-amber', img: 'https://images.unsplash.com/photo-1565058727220-4318c679234b?auto=format&fit=crop&w=1600&q=80' },
    { id: 2, name: 'ì¤‘ì„¸ ì‹œëŒ€', color: 'age-slate', img: 'https://images.unsplash.com/photo-1605806616949-1e87b487bc2a?auto=format&fit=crop&w=1600&q=80' },
    { id: 3, name: 'ì‚°ì—… ì‹œëŒ€', color: 'age-orange', img: 'https://images.unsplash.com/photo-1535970793577-7d045c777e34?auto=format&fit=crop&w=1600&q=80' },
    { id: 4, name: 'í˜„ëŒ€ ì‹œëŒ€', color: 'age-cyan', img: 'https://images.unsplash.com/photo-1480714378408-67cf0d13bc1b?auto=format&fit=crop&w=1600&q=80' },
    { id: 5, name: 'ìš°ì£¼ ì‹œëŒ€', color: 'age-violet', img: 'https://images.unsplash.com/photo-1451187580459-43490279c0fa?auto=format&fit=crop&w=1600&q=80' }
];
const TECH_TREE = [
    { id: 'fire', name: 'ë¶ˆì˜ ë°œê²¬', cost: 10, type: 'sci', ageReq: 0, unlocks: 'ancient', desc: 'ê³ ëŒ€ ì‹œëŒ€ë¡œ ì§„ì…' },
    { id: 'tools', name: 'ì„ê¸° ë„êµ¬', cost: 20, type: 'sci', ageReq: 0, effect: 'prod_eff', desc: 'ìƒì‚° íš¨ìœ¨ 2ë°°' },
    { id: 'farming', name: 'ë†ê²½ ì‹œì‘', cost: 100, type: 'sci', ageReq: 1, effect: 'food_eff', desc: 'ì‹ëŸ‰ íš¨ìœ¨ 2ë°°' },
    { id: 'writing', name: 'ë¬¸ì ë°œëª…', cost: 200, type: 'sci', ageReq: 1, unlocks: 'medieval', desc: 'ì¤‘ì„¸ ì‹œëŒ€ë¡œ ì§„ì…' },
    { id: 'steel', name: 'ê°•ì²  ì œë ¨', cost: 500, type: 'sci', ageReq: 2, effect: 'prod_eff', desc: 'ìƒì‚° íš¨ìœ¨ 2ë°°' },
    { id: 'printing', name: 'ì¸ì‡„ìˆ ', cost: 800, type: 'sci', ageReq: 2, unlocks: 'industrial', desc: 'ì‚°ì—… ì‹œëŒ€ë¡œ ì§„ì…' },
    { id: 'steam', name: 'ì¦ê¸° ê¸°ê´€', cost: 2000, type: 'sci', ageReq: 3, effect: 'auto_prod', desc: 'ìë™ ìƒì‚°ë ¥ ì¦ê°€' },
    { id: 'electricity', name: 'ì „ê¸°', cost: 3500, type: 'sci', ageReq: 3, unlocks: 'modern', desc: 'í˜„ëŒ€ ì‹œëŒ€ë¡œ ì§„ì…' },
    { id: 'computer', name: 'ì»´í“¨í„°', cost: 8000, type: 'sci', ageReq: 4, effect: 'sci_eff', desc: 'ê³¼í•™ íš¨ìœ¨ 2ë°°' },
    { id: 'rocketry', name: 'ë¡œì¼“ ê³µí•™', cost: 15000, type: 'sci', ageReq: 4, unlocks: 'space', desc: 'ìš°ì£¼ ì‹œëŒ€ë¡œ ì§„ì…' },
    { id: 'ftl', name: 'ì´ˆê´‘ì† ì—¬í–‰', cost: 50000, type: 'sci', ageReq: 5, unlocks: 'win', desc: 'ìŠ¹ë¦¬' }
];
const BUILDINGS = {
    farm: { name: 'ë†ì¥/ì±„ì§‘ì§€', cost: { food: 10, prod: 0, sci: 0 }, output: { food: 1, prod: 0, sci: 0 }, desc: 'ì‹ëŸ‰ ìƒì‚°' },
    mine: { name: 'ê´‘ì‚°/ê³µì¥', cost: { food: 20, prod: 10, sci: 0 }, output: { food: 0, prod: 1, sci: 0 }, desc: 'ìƒì‚°ë ¥ ìƒì‚°' },
    lab: { name: 'ì—°êµ¬ì†Œ', cost: { food: 50, prod: 50, sci: 0 }, output: { food: 0, prod: 0, sci: 1 }, desc: 'ê³¼í•™ ìƒì‚°' }
};

const SLOT_PREFIX = 'civ_save_slot_';
const SLOT_COUNT = 3;

// --- ì„œë¸Œ ì»´í¬ë„ŒíŠ¸ ---
function SaveLoadModal({ mode, onClose, onAction, slots }) {
    return (
        <div className="modal-overlay animate-fade-in">
            <div className="modal">
                <div className="modal-header">
                    <h3 className="modal-title">
                        {mode === 'save' ? <Save size={20} className="icon-blue" /> : <FilePlus size={20} className="icon-green" />}
                        {mode === 'save' ? 'ê²Œì„ ì €ì¥' : 'ê²Œì„ ë¶ˆëŸ¬ì˜¤ê¸°'}
                    </h3>
                    <button onClick={onClose} className="modal-close"><X size={20} /></button>
                </div>
                <div className="modal-body">
                    <div className="slot-list">
                        {Array.from({ length: SLOT_COUNT }).map((_, idx) => {
                            const slotId = idx + 1;
                            const data = slots[slotId];
                            const race = data ? RACES.find(r => r.id === data.selectedRaceId) : null;

                            return (
                                <div key={slotId}
                                    onClick={() => onAction(slotId)}
                                    className={`slot-card ${data ? 'has-data' : 'empty'}`}>
                                    <div className="slot-content">
                                        <div className="slot-number">#{slotId}</div>
                                        {data ? (
                                            <div className="slot-info">
                                                <div className="slot-icon">{race ? race.icon : <User />}</div>
                                                <div>
                                                    <div className="slot-race">{race ? race.name : 'ì•Œ ìˆ˜ ì—†ìŒ'}</div>
                                                    <div className="slot-meta">{AGES[data.currentAge].name} â€¢ {new Date(data.timestamp).toLocaleString()}</div>
                                                </div>
                                            </div>
                                        ) : (
                                            <div className="slot-empty-text">ë¹„ì–´ ìˆìŒ</div>
                                        )}
                                    </div>
                                    {mode === 'save' && <div className="slot-action save">{data ? 'ë®ì–´ì“°ê¸°' : 'ì €ì¥í•˜ê¸°'}</div>}
                                    {mode === 'load' && data && <div className="slot-action load">ë¶ˆëŸ¬ì˜¤ê¸°</div>}
                                </div>
                            );
                        })}
                    </div>
                </div>
            </div>
        </div>
    );
}

function UpgradeModal({ onClose, buildings, buildingLevels, resources, onUpgrade, getUpgradeCost }) {
    return (
        <div className="modal-overlay animate-fade-in">
            <div className="modal-lg">
                <div className="modal-header">
                    <h3 className="modal-title">
                        <Wrench size={20} className="icon-purple" /> ì‹œì„¤ ê¸°ìˆ  ê°•í™”
                    </h3>
                    <button onClick={onClose} className="modal-close"><X size={20} /></button>
                </div>
                <div className="modal-body padded">
                    <p className="upgrade-intro">
                        ê±´ë¬¼ì˜ ê¸°ë³¸ ìƒì‚° íš¨ìœ¨ì„ ì˜êµ¬ì ìœ¼ë¡œ ì¦ê°€ì‹œí‚µë‹ˆë‹¤. <br />
                        <span className="highlight">ë ˆë²¨ë‹¹ +20% ì¶”ê°€ íš¨ìœ¨</span>
                    </p>
                    <div className="upgrade-list">
                        {Object.keys(BUILDINGS).map(key => {
                            const currentLevel = buildingLevels[key] || 0;
                            const costSci = getUpgradeCost(key);
                            const canAfford = resources.sci >= costSci;
                            const isMax = currentLevel >= 10;

                            return (
                                <div key={key} className="upgrade-item">
                                    <div className="upgrade-item-header">
                                        <div className="item-name">{BUILDINGS[key].name}</div>
                                        <div className="item-level">Lv.{currentLevel} <span className="arrow">â†’</span> Lv.{currentLevel + 1}</div>
                                    </div>
                                    <div className="upgrade-item-footer">
                                        <div className="item-efficiency">
                                            íš¨ìœ¨: <span className="current">{100 + currentLevel * 20}%</span>
                                            {!isMax && <span className="next">â†’ {100 + (currentLevel + 1) * 20}% <ArrowUp size={10} /></span>}
                                        </div>
                                        {isMax ? (
                                            <button className="upgrade-action-btn maxed">ìµœëŒ€ ë ˆë²¨</button>
                                        ) : (
                                            <button
                                                onClick={() => onUpgrade(key)}
                                                disabled={!canAfford}
                                                className={`upgrade-action-btn ${canAfford ? 'affordable' : 'unaffordable'}`}>
                                                <span className="cost">ë¹„ìš©: <FlaskConical size={12} className="icon-blue" /> {costSci.toLocaleString()}</span>
                                                <ArrowUp size={12} />
                                            </button>
                                        )}
                                    </div>
                                </div>
                            );
                        })}
                    </div>
                </div>
            </div>
        </div>
    );
}

function RaceSelectionScreen({ onSelect, onLoad }) {
    return (
        <div className="selection-screen">
            <div className="selection-header animate-fade-in">
                <h1 className="selection-title">ë¬¸ëª… ì‹œë®¬ë ˆì´ì…˜</h1>
                <p className="selection-subtitle">ë‹¹ì‹ ì˜ ë¬¸ëª…ì„ ì„ íƒí•˜ì—¬ ìš°ì£¼ ì‹œëŒ€ë¡œ ì´ë„ì‹­ì‹œì˜¤.</p>
            </div>

            <div className="guide-box animate-fade-in">
                <h3 className="guide-title">
                    <Scroll size={20} className="icon-blue" /> ê²Œì„ ê°€ì´ë“œ
                </h3>
                <div className="guide-grid">
                    <div className="guide-item"><div className="guide-icon icon-text-yellow"><Wheat size={16} /></div><div><strong>ìì› ê´€ë¦¬</strong>ì‹ëŸ‰(ìœ ì§€), ìƒì‚°(ê±´ì„¤), ê³¼í•™(ì—°êµ¬) 3ê°€ì§€ ìì›ì„ ëª¨ì•„ ë¬¸ëª…ì„ ë°œì „ì‹œí‚¤ì„¸ìš”.</div></div>
                    <div className="guide-item"><div className="guide-icon icon-text-blue"><FlaskConical size={16} /></div><div><strong>ì‹œëŒ€ ë°œì „</strong>ê¸°ìˆ ì„ ì—°êµ¬í•˜ì—¬ ì›ì‹œ ì‹œëŒ€ë¶€í„° ìš°ì£¼ ì‹œëŒ€ê¹Œì§€ 6ë‹¨ê³„ì˜ ì‹œëŒ€ë¥¼ ê±°ì³ì•¼ í•©ë‹ˆë‹¤.</div></div>
                    <div className="guide-item"><div className="guide-icon icon-text-yellow"><Crown size={16} /></div><div><strong>ë¶ˆê°€ì‚¬ì˜ ê±´ì„¤</strong>ê° ì¢…ì¡± ê³ ìœ ì˜ 'ë¶ˆê°€ì‚¬ì˜'ë¥¼ ê±´ì„¤í•˜ë©´ ì˜êµ¬ì ì´ê³  ê°•ë ¥í•œ ë³´ë„ˆìŠ¤ë¥¼ ì–»ìŠµë‹ˆë‹¤.</div></div>
                    <div className="guide-item"><div className="guide-icon icon-text-red"><Flame size={16} /></div><div><strong>ì¬í•´ ëŒ€ë¹„</strong>ë¬´ì‘ìœ„ë¡œ ë°œìƒí•˜ëŠ” ì¬í•´ëŠ” ìì›ì´ë‚˜ ê±´ë¬¼ì„ íŒŒê´´í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.</div></div>
                </div>
            </div>

            <div className="load-game-btn animate-fade-in">
                <button onClick={onLoad}>
                    <FilePlus size={20} /> ì €ì¥ëœ ê²Œì„ ë¶ˆëŸ¬ì˜¤ê¸°
                </button>
            </div>

            <div className="race-grid animate-fade-in">
                {RACES.map(race => (
                    <div key={race.id} onClick={() => onSelect(race)} className="race-card">
                        <div className="race-icon">{race.icon}</div>
                        <h2 className="race-name">{race.name}</h2>
                        <p className="race-desc">{race.desc}</p>
                        <div className="race-stats">
                            <div className="stat-row"><span className="stat-label">ì‹ëŸ‰ íš¨ìœ¨</span> <span className={`stat-value ${race.bonus.food > 1 ? 'positive' : race.bonus.food < 1 ? 'negative' : 'neutral'}`}>{race.bonus.food * 100}%</span></div>
                            <div className="stat-row"><span className="stat-label">ìƒì‚° íš¨ìœ¨</span> <span className={`stat-value ${race.bonus.prod > 1 ? 'positive' : race.bonus.prod < 1 ? 'negative' : 'neutral'}`}>{race.bonus.prod * 100}%</span></div>
                            <div className="stat-row"><span className="stat-label">ê³¼í•™ íš¨ìœ¨</span> <span className={`stat-value ${race.bonus.sci > 1 ? 'positive' : race.bonus.sci < 1 ? 'negative' : 'neutral'}`}>{race.bonus.sci * 100}%</span></div>
                        </div>
                        <div className="race-start">ìƒˆ ê²Œì„ ì‹œì‘</div>
                    </div>
                ))}
            </div>
        </div>
    );
}

function VictoryScreen({ onRestart }) {
    return (
        <div className="victory-screen">
            <div className="victory-bg"></div>
            <div className="victory-content animate-fade-in">
                <Rocket size={80} className="victory-icon" />
                <h1 className="victory-title">ìš°ì£¼ ì‹œëŒ€ ë„ë‹¬</h1>
                <p className="victory-text">ë‹¹ì‹ ì˜ ë¬¸ëª…ì€ ì§€êµ¬ì˜ í•œê³„ë¥¼ ë„˜ì–´ ë³„ë“¤ì„ í–¥í•´ ë‚˜ì•„ê°‘ë‹ˆë‹¤.<br />ìœ„ëŒ€í•œ ì—¬ì •ì˜ ìƒˆë¡œìš´ ì‹œì‘ì…ë‹ˆë‹¤.</p>
                <button onClick={onRestart} className="victory-btn">ë©”ì¸ í™”ë©´ìœ¼ë¡œ</button>
            </div>
        </div>
    );
}

function ResourceCard({ icon, label, value, rate }) {
    return (
        <div className="resource-card">
            <div className="resource-label">{icon} {label}</div>
            <div className="resource-value">{Math.floor(value).toLocaleString()}</div>
            <div className="resource-rate">+{rate.toFixed(1)}/ì´ˆ</div>
        </div>
    );
}

function ActionButton({ onClick, icon, label, desc, colorClass }) {
    return (
        <button onClick={onClick} className={`action-btn ${colorClass}`}>
            <div className="btn-icon">{icon}</div>
            <div className="btn-content">
                <div className="btn-label">{label}</div>
                <div className="btn-desc">{desc}</div>
            </div>
        </button>
    );
}

function SectionTitle({ title }) {
    return <h2 className="section-title">{title}</h2>;
}

function App() {
    const [gameState, setGameState] = useState('selection');
    const [selectedRace, setSelectedRace] = useState(null);
    const { initAudio, playSound, isMuted, toggleMute } = useSound();
    const [resources, setResources] = useState({ food: 0, prod: 0, sci: 0 });
    const [buildings, setBuildings] = useState({ farm: 0, mine: 0, lab: 0 });
    const [buildingLevels, setBuildingLevels] = useState({ farm: 0, mine: 0, lab: 0 });
    const [currentAge, setCurrentAge] = useState(0);
    const [researched, setResearched] = useState([]);
    const [logs, setLogs] = useState(["ë¬¸ëª…ì˜ ì—¬ëª…ì´ ë°ì•˜ìŠµë‹ˆë‹¤."]);
    const [multipliers, setMultipliers] = useState({ food: 1, prod: 1, sci: 1 });
    const [hasWonder, setHasWonder] = useState(false);
    const [disasterActive, setDisasterActive] = useState(false);
    const [currentSlot, setCurrentSlot] = useState(null);
    const [slotsData, setSlotsData] = useState({});
    const [isModalOpen, setIsModalOpen] = useState(false);
    const [modalMode, setModalMode] = useState('save');
    const [isUpgradeModalOpen, setIsUpgradeModalOpen] = useState(false);
    const [isFullScreen, setIsFullScreen] = useState(false);

    const refreshSlots = () => {
        const loaded = {};
        for (let i = 1; i <= SLOT_COUNT; i++) {
            const saved = localStorage.getItem(SLOT_PREFIX + i);
            if (saved) loaded[i] = JSON.parse(saved);
        }
        setSlotsData(loaded);
    };

    useEffect(() => { refreshSlots(); }, []);

    const toggleFullScreen = () => {
        if (!document.fullscreenElement) {
            document.documentElement.requestFullscreen().catch((e) => {
                console.error(`Error attempting to enable full-screen mode: ${e.message} (${e.name})`);
            });
        } else {
            if (document.exitFullscreen) {
                document.exitFullscreen();
            }
        }
    };

    useEffect(() => {
        const handleFullScreenChange = () => {
            setIsFullScreen(!!document.fullscreenElement);
        };
        document.addEventListener('fullscreenchange', handleFullScreenChange);
        return () => {
            document.removeEventListener('fullscreenchange', handleFullScreenChange);
        };
    }, []);

    const triggerDisaster = useCallback(() => {
        const possibleDisasters = DISASTERS_BY_AGE[currentAge];
        if (!possibleDisasters || possibleDisasters.length === 0) return;

        const disaster = possibleDisasters[Math.floor(Math.random() * possibleDisasters.length)];
        let msg = `[ì¬í•´] ${disaster.desc}`;

        setDisasterActive(true);
        playSound('disaster');
        setTimeout(() => setDisasterActive(false), 500);

        if (disaster.type === 'resource') {
            setResources(prev => ({
                ...prev,
                [disaster.target]: Math.max(0, Math.floor(prev[disaster.target] * (1 - disaster.ratio)))
            }));
        } else if (disaster.type === 'building') {
            setBuildings(prev => ({
                ...prev,
                [disaster.target]: Math.max(0, prev[disaster.target] - disaster.count)
            }));
        } else if (disaster.type === 'building_all') {
            setBuildings(prev => {
                const next = { ...prev };
                Object.keys(next).forEach(k => next[k] = Math.max(0, next[k] - 1));
                return next;
            });
        }

        setLogs(prev => [msg, ...prev].slice(0, 50));
    }, [currentAge, playSound]);

    useEffect(() => {
        if (gameState !== 'playing') return;
        const interval = setInterval(() => {
            setResources(prev => {
                const raceBonus = selectedRace.bonus;
                const getEff = (type) => 1 + (buildingLevels[type] || 0) * 0.2;

                const autoFood = buildings.farm * 1 * raceBonus.food * multipliers.food * getEff('farm');
                const autoProd = buildings.mine * 1 * raceBonus.prod * multipliers.prod * getEff('mine');
                const autoSci = buildings.lab * 1 * raceBonus.sci * multipliers.sci * getEff('lab');
                return {
                    food: prev.food + autoFood,
                    prod: prev.prod + autoProd,
                    sci: prev.sci + autoSci
                };
            });

            if (Math.random() < 0.005) {
                triggerDisaster();
            }

        }, 1000);
        return () => clearInterval(interval);
    }, [gameState, buildings, buildingLevels, selectedRace, multipliers, triggerDisaster]);

    useEffect(() => {
        if (gameState !== 'playing' || !currentSlot) return;
        const saveInterval = setInterval(() => {
            saveToSlot(currentSlot, true);
        }, 30000);
        return () => clearInterval(saveInterval);
    }, [gameState, currentSlot, selectedRace, resources, buildings, buildingLevels, currentAge, researched, multipliers, hasWonder, logs]);

    const addLog = (msg) => {
        setLogs(prev => [msg, ...prev].slice(0, 50));
    };

    const saveToSlot = (slotId, silent = false) => {
        if (!selectedRace) return;
        const data = {
            selectedRaceId: selectedRace.id,
            resources,
            buildings,
            buildingLevels,
            currentAge,
            researched,
            multipliers,
            hasWonder,
            logs,
            timestamp: Date.now()
        };
        localStorage.setItem(SLOT_PREFIX + slotId, JSON.stringify(data));

        if (!silent) {
            addLog(`ê²Œì„ì´ ìŠ¬ë¡¯ ${slotId}ë²ˆì— ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤.`);
            playSound('build');
            refreshSlots();
            setCurrentSlot(slotId);
            setIsModalOpen(false);
        }
    };

    const loadFromSlot = (slotId) => {
        const data = slotsData[slotId];
        if (!data) return;

        const race = RACES.find(r => r.id === data.selectedRaceId);
        if (race) setSelectedRace(race);

        setResources(data.resources);
        setBuildings({ ...{ farm: 0, mine: 0, lab: 0 }, ...data.buildings });
        setBuildingLevels({ ...{ farm: 0, mine: 0, lab: 0 }, ...data.buildingLevels });
        setCurrentAge(data.currentAge);
        setResearched(data.researched);
        setMultipliers(data.multipliers);
        setHasWonder(data.hasWonder);
        setLogs(data.logs);

        setCurrentSlot(slotId);
        setGameState('playing');
        initAudio();
        setIsModalOpen(false);
    };

    const goHome = () => {
        if (currentSlot) saveToSlot(currentSlot, true);
        setGameState('selection');
        setCurrentSlot(null);
    };

    const startGame = (race) => {
        initAudio();
        setSelectedRace(race);
        setGameState('playing');
        setCurrentSlot(null);
        setResources({ food: 0, prod: 0, sci: 0 });
        setBuildings({ farm: 0, mine: 0, lab: 0 });
        setBuildingLevels({ farm: 0, mine: 0, lab: 0 });
        setCurrentAge(0);
        setResearched([]);
        setMultipliers({ food: 1, prod: 1, sci: 1 });
        setHasWonder(false);
        setLogs([`${race.name} ì¢…ì¡±ìœ¼ë¡œ ì—­ì‚¬ë¥¼ ì‹œì‘í•©ë‹ˆë‹¤.`]);
        playSound('research');
    };

    const openSaveModal = () => {
        refreshSlots();
        setModalMode('save');
        setIsModalOpen(true);
    };

    const openLoadModal = () => {
        refreshSlots();
        setModalMode('load');
        setIsModalOpen(true);
    };

    const handleSlotAction = (slotId) => {
        if (modalMode === 'save') {
            if (slotsData[slotId] && !confirm(`ìŠ¬ë¡¯ ${slotId}ë²ˆì— ë®ì–´ì“°ì‹œê² ìŠµë‹ˆê¹Œ?`)) return;
            saveToSlot(slotId);
        } else {
            if (!slotsData[slotId]) return;
            loadFromSlot(slotId);
        }
    };

    const calculateClickValue = (type) => {
        if (!selectedRace) return 1;
        const bonus = selectedRace.bonus[type] || 1;
        const mult = multipliers[type] || 1;
        const baseAmount = 1 + (currentAge * 1);
        return baseAmount * bonus * mult;
    };

    const gather = (type) => {
        playSound('click');
        setResources(prev => {
            const amount = calculateClickValue(type);
            return { ...prev, [type]: prev[type] + amount };
        });
    };

    const buyBuilding = (type) => {
        const building = BUILDINGS[type];
        const count = buildings[type];
        const costFood = Math.floor(building.cost.food * Math.pow(1.15, count));
        const costProd = Math.floor(building.cost.prod * Math.pow(1.15, count));
        const costSci = Math.floor(building.cost.sci * Math.pow(1.15, count));

        if (resources.food >= costFood && resources.prod >= costProd && resources.sci >= costSci) {
            playSound('build');
            setResources(prev => ({
                ...prev,
                food: prev.food - costFood,
                prod: prev.prod - costProd,
                sci: prev.sci - costSci
            }));
            setBuildings(prev => ({ ...prev, [type]: prev[type] + 1 }));
            addLog(`${building.name} ê±´ì„¤ ì™„ë£Œ!`);
        } else {
            playSound('error');
            addLog("ìì›ì´ ë¶€ì¡±í•©ë‹ˆë‹¤.");
        }
    };

    const upgradeBuilding = (type) => {
        const currentLevel = buildingLevels[type] || 0;
        if (currentLevel >= 10) return;

        const costSci = getUpgradeCost(type);

        if (resources.sci >= costSci) {
            playSound('upgrade');
            setResources(prev => ({ ...prev, sci: prev.sci - costSci }));
            setBuildingLevels(prev => ({ ...prev, [type]: currentLevel + 1 }));
            addLog(`${BUILDINGS[type].name} ê¸°ìˆ  ê°•í™” ì™„ë£Œ (Lv.${currentLevel + 1})`);
        } else {
            playSound('error');
            addLog("ê³¼í•™ë ¥ì´ ë¶€ì¡±í•©ë‹ˆë‹¤.");
        }
    };

    const buildWonder = () => {
        if (hasWonder) return;
        const wonder = WONDERS[selectedRace.id];
        const cost = wonder.cost;

        if (resources.food >= cost.food && resources.prod >= cost.prod && resources.sci >= cost.sci) {
            playSound('wonder');
            setResources(prev => ({
                food: prev.food - cost.food,
                prod: prev.prod - cost.prod,
                sci: prev.sci - cost.sci
            }));
            setHasWonder(true);
            addLog(`ìœ„ëŒ€í•œ ì—…ì ! [${wonder.name}] ê±´ì„¤ ì™„ë£Œ!`);

            setMultipliers(prev => {
                if (wonder.effect === 'all_boost') return { food: prev.food * 1.5, prod: prev.prod * 1.5, sci: prev.sci * 1.5 };
                if (wonder.effect === 'prod_boost') return { ...prev, prod: prev.prod * 3.0 };
                if (wonder.effect === 'sci_boost') return { ...prev, sci: prev.sci * 2.0 };
                return prev;
            });
        } else {
            playSound('error');
            addLog("ë¶ˆê°€ì‚¬ì˜ ê±´ì„¤ ìì›ì´ ë¶€ì¡±í•©ë‹ˆë‹¤.");
        }
    };

    const research = (tech) => {
        if (resources.sci >= tech.cost) {
            setResources(prev => ({ ...prev, sci: prev.sci - tech.cost }));
            setResearched(prev => [...prev, tech.id]);
            addLog(`[ê¸°ìˆ ] ${tech.name} ì—°êµ¬ ì™„ë£Œ!`);

            if (tech.unlocks) {
                if (tech.unlocks === 'win') {
                    setGameState('victory');
                    playSound('age');
                } else {
                    const nextAgeIdx = AGES.findIndex(a =>
                        (tech.unlocks === 'ancient' && a.id === 1) ||
                        (tech.unlocks === 'medieval' && a.id === 2) ||
                        (tech.unlocks === 'industrial' && a.id === 3) ||
                        (tech.unlocks === 'modern' && a.id === 4) ||
                        (tech.unlocks === 'space' && a.id === 5)
                    );
                    if (nextAgeIdx !== -1) {
                        setCurrentAge(nextAgeIdx);
                        addLog(`>>> ${AGES[nextAgeIdx].name}ë¡œ ì§„ì…í–ˆìŠµë‹ˆë‹¤! <<<`);
                        playSound('age');
                    } else {
                        playSound('research');
                    }
                }
            } else {
                playSound('research');
            }

            if (tech.effect) {
                setMultipliers(prev => {
                    if (tech.effect === 'food_eff') return { ...prev, food: prev.food * 2 };
                    if (tech.effect === 'prod_eff') return { ...prev, prod: prev.prod * 2 };
                    if (tech.effect === 'sci_eff') return { ...prev, sci: prev.sci * 2 };
                    return prev;
                });
            }
        } else {
            playSound('error');
            addLog("ê³¼í•™ë ¥ì´ ë¶€ì¡±í•©ë‹ˆë‹¤.");
        }
    };

    const getBuildingCost = (type) => {
        const base = BUILDINGS[type].cost;
        const count = buildings[type];
        return {
            food: Math.floor(base.food * Math.pow(1.15, count)),
            prod: Math.floor(base.prod * Math.pow(1.15, count)),
            sci: Math.floor(base.sci * Math.pow(1.15, count))
        };
    };

    const getUpgradeCost = (type) => {
        const currentLevel = buildingLevels[type] || 0;
        return Math.floor(200 * Math.pow(1.1, currentLevel));
    }


    if (gameState === 'selection') {
        return (
            <>
                <RaceSelectionScreen onSelect={startGame} onLoad={openLoadModal} />
                {isModalOpen && <SaveLoadModal mode={modalMode} slots={slotsData} onClose={() => setIsModalOpen(false)} onAction={handleSlotAction} />}
            </>
        );
    }

    if (gameState === 'victory') {
        return <VictoryScreen onRestart={goHome} />;
    }

    return (
        <div className={`game-container ${disasterActive ? 'animate-shake disaster-flash' : ''}`}>
            {isModalOpen && <SaveLoadModal mode={modalMode} slots={slotsData} onClose={() => setIsModalOpen(false)} onAction={handleSlotAction} />}
            {isUpgradeModalOpen && <UpgradeModal onClose={() => setIsUpgradeModalOpen(false)} buildings={buildings} buildingLevels={buildingLevels} resources={resources} onUpgrade={upgradeBuilding} getUpgradeCost={getUpgradeCost} />}

            {/* ìƒë‹¨ í—¤ë” */}
            <header
                className="game-header header-bg"
                style={{ backgroundImage: `url(${AGES[currentAge].img})` }}
            >
                <div className="header-overlay"></div>

                {/* ì»¨íŠ¸ë¡¤ ë²„íŠ¼ ê·¸ë£¹ */}
                <div className="control-buttons">
                    <button onClick={toggleFullScreen} title={isFullScreen ? "ì „ì²´í™”ë©´ ì¢…ë£Œ" : "ì „ì²´í™”ë©´"} className="control-btn">
                        {isFullScreen ? <Minimize size={18} /> : <Maximize size={18} />}
                    </button>
                    <button onClick={goHome} title="ë©”ì¸ìœ¼ë¡œ" className="control-btn">
                        <Home size={18} />
                    </button>
                    <button onClick={openSaveModal} title="ì €ì¥í•˜ê¸°" className="control-btn">
                        <Save size={18} />
                    </button>
                    <button onClick={toggleMute} title="ìŒì†Œê±°" className="control-btn">
                        {isMuted ? <VolumeX size={18} /> : <Volume2 size={18} />}
                    </button>
                </div>

                <div className="header-content">
                    <div className="header-top">
                        <div className="header-info">
                            <div className={`age-icon ${AGES[currentAge].color}`}>
                                <Globe size={32} />
                            </div>
                            <div>
                                <h1 className={`age-title ${AGES[currentAge].color}`}>{AGES[currentAge].name}</h1>
                                <p className="civ-info">
                                    {selectedRace.name} ë¬¸ëª…
                                    <span className="info-badge">ëª©í‘œ: ìš°ì£¼ ì§„ì¶œ</span>
                                    {currentSlot && <span className="slot-badge">ìŠ¬ë¡¯ {currentSlot}</span>}
                                </p>
                            </div>
                        </div>
                    </div>

                    <div className="resource-bar">
                        <ResourceCard icon={<Wheat size={20} className="icon-text-yellow" />} label="ì‹ëŸ‰" value={resources.food} rate={buildings.farm * selectedRace.bonus.food * multipliers.food * (1 + buildingLevels.farm * 0.2)} />
                        <ResourceCard icon={<Hammer size={20} className="icon-text-orange" />} label="ìƒì‚°ë ¥" value={resources.prod} rate={buildings.mine * selectedRace.bonus.prod * multipliers.prod * (1 + buildingLevels.mine * 0.2)} />
                        <ResourceCard icon={<FlaskConical size={20} className="icon-text-blue" />} label="ê³¼í•™" value={resources.sci} rate={buildings.lab * selectedRace.bonus.sci * multipliers.sci * (1 + buildingLevels.lab * 0.2)} />
                    </div>
                </div>
            </header>

            {/* ë©”ì¸ ì½˜í…ì¸  */}
            <div className="main-content">
                {/* ì™¼ìª½ íŒ¨ë„ */}
                <div className="panel-left">
                    <div className="panel-inner">
                        <SectionTitle title="ê¸°ë³¸ í™œë™" />
                        <div className="action-grid">
                            <ActionButton
                                onClick={() => gather('food')}
                                icon={<Wheat size={18} />}
                                label="ì‹ëŸ‰ ì±„ì§‘"
                                desc={`+${Math.floor(calculateClickValue('food')).toLocaleString()} (í´ë¦­)`}
                                colorClass="btn-food"
                            />
                            <ActionButton
                                onClick={() => gather('prod')}
                                icon={<Pickaxe size={18} />}
                                label="ìì› ì±„êµ´"
                                desc={`+${Math.floor(calculateClickValue('prod')).toLocaleString()} (í´ë¦­)`}
                                colorClass="btn-prod"
                            />
                            <ActionButton
                                onClick={() => gather('sci')}
                                icon={<Scroll size={18} />}
                                label="ìì—° ê´€ì°°"
                                desc={`+${Math.floor(calculateClickValue('sci')).toLocaleString()} (í´ë¦­)`}
                                colorClass="btn-sci"
                            />
                        </div>

                        <SectionTitle title="ê±´ë¬¼ ê±´ì„¤" />
                        <div className="building-list">
                            {Object.keys(BUILDINGS).map(key => {
                                const cost = getBuildingCost(key);
                                const canAfford = resources.food >= cost.food && resources.prod >= cost.prod && resources.sci >= cost.sci;
                                const outputName = key === 'farm' ? 'ì‹ëŸ‰' : key === 'mine' ? 'ìƒì‚°' : 'ê³¼í•™';
                                const baseOutput = 1;
                                const bonusOutput = baseOutput * ((buildingLevels[key] || 0) * 0.2);

                                return (
                                    <div key={key} onClick={() => buyBuilding(key)}
                                        className={`building-card ${canAfford ? 'affordable' : 'unaffordable'}`}>
                                        <div className="building-info">
                                            <div className="building-name">
                                                {BUILDINGS[key].name} (Lv.{buildings[key]})
                                            </div>
                                            <div className="building-cost">
                                                ë¹„ìš©:
                                                {cost.food > 0 && <span className="cost-food"> ğŸŒ¾{cost.food.toLocaleString()}</span>}
                                                {cost.prod > 0 && <span className="cost-prod"> âš’ï¸{cost.prod.toLocaleString()}</span>}
                                                {cost.sci > 0 && <span className="cost-sci"> ğŸ§ª{cost.sci.toLocaleString()}</span>}
                                            </div>
                                        </div>
                                        <div className="building-output">
                                            <div className="output-value">
                                                +{baseOutput}
                                                {bonusOutput > 0 && <span className="output-bonus">(+{bonusOutput.toFixed(1)})</span>}
                                            </div>
                                            <div className="output-label">{outputName}/ì´ˆ (ê°œë‹¹)</div>
                                        </div>
                                    </div>
                                );
                            })}
                        </div>

                        {/* ì—…ê·¸ë ˆì´ë“œ ë²„íŠ¼ */}
                        <button onClick={() => setIsUpgradeModalOpen(true)} className="upgrade-btn">
                            <div className="flex items-center gap-3">
                                <div className="upgrade-icon">
                                    <Wrench size={20} />
                                </div>
                                <div className="upgrade-info">
                                    <div className="upgrade-title">ì‹œì„¤ ê¸°ìˆ  ê°•í™”</div>
                                    <div className="upgrade-desc">ê±´ë¬¼ ìƒì‚° íš¨ìœ¨ ì˜êµ¬ ì¦ê°€</div>
                                </div>
                            </div>
                            <ArrowUp size={16} className="upgrade-arrow" />
                        </button>

                        <SectionTitle title="ë¶ˆê°€ì‚¬ì˜" />
                        {hasWonder ? (
                            <div className="wonder-complete wonder-glow">
                                <Crown size={32} className="wonder-icon" />
                                <div className="wonder-name">{WONDERS[selectedRace.id].name} ê±´ì„¤ë¨</div>
                                <div className="wonder-effect">ì˜êµ¬ íš¨ê³¼ ì ìš© ì¤‘</div>
                            </div>
                        ) : (
                            <div onClick={buildWonder}
                                className={`wonder-card ${resources.food >= WONDERS[selectedRace.id].cost.food && resources.prod >= WONDERS[selectedRace.id].cost.prod && resources.sci >= WONDERS[selectedRace.id].cost.sci ? 'affordable' : 'unaffordable'}`}>
                                <div className="wonder-content">
                                    <div className="wonder-icon-wrapper">
                                        <Crown size={24} />
                                    </div>
                                    <div className="wonder-details">
                                        <div className="wonder-title">{WONDERS[selectedRace.id].name}</div>
                                        <div className="wonder-desc">{WONDERS[selectedRace.id].desc}</div>
                                        <div className="wonder-costs">
                                            {WONDERS[selectedRace.id].cost.food > 0 && <div className={resources.food >= WONDERS[selectedRace.id].cost.food ? 'text-yellow' : 'text-red'}>ì‹ëŸ‰: {WONDERS[selectedRace.id].cost.food.toLocaleString()}</div>}
                                            {WONDERS[selectedRace.id].cost.prod > 0 && <div className={resources.prod >= WONDERS[selectedRace.id].cost.prod ? 'text-orange' : 'text-red'}>ìƒì‚°: {WONDERS[selectedRace.id].cost.prod.toLocaleString()}</div>}
                                            {WONDERS[selectedRace.id].cost.sci > 0 && <div className={resources.sci >= WONDERS[selectedRace.id].cost.sci ? 'text-blue' : 'text-red'}>ê³¼í•™: {WONDERS[selectedRace.id].cost.sci.toLocaleString()}</div>}
                                        </div>
                                    </div>
                                </div>
                            </div>
                        )}
                    </div>
                </div>

                {/* ì¤‘ì•™ íŒ¨ë„ */}
                <div className="panel-center">
                    <div className="log-overlay"></div>
                    <div className="log-header">
                        <SectionTitle title="ì—­ì‚¬ì˜ ê¸°ë¡" />
                    </div>
                    <div className="log-content">
                        {logs.map((log, i) => (
                            <div key={i} className={`log-entry animate-fade-in ${log.includes('>>>') ? 'log-age' : ''}`}>
                                {!log.includes('>>>') && <span className="log-number">[{logs.length - i}]</span>}
                                <span className={`${log.includes('[ì¬í•´]') ? 'log-disaster' : ''} ${log.includes('[ê¸°ìˆ ]') ? 'log-tech' : ''}`}>
                                    {log}
                                </span>
                            </div>
                        ))}
                    </div>
                </div>

                {/* ì˜¤ë¥¸ìª½ íŒ¨ë„ */}
                <div className="panel-right">
                    <div className="panel-inner">
                        <SectionTitle title="ê¸°ìˆ  ë°œì „í‘œ" />
                        <div className="tech-list">
                            {TECH_TREE.map((tech) => {
                                const isResearched = researched.includes(tech.id);
                                const isAvailable = !isResearched && tech.ageReq <= currentAge;
                                const canAfford = resources.sci >= tech.cost;

                                if (!isResearched && tech.ageReq > currentAge) return null;

                                return (
                                    <div key={tech.id} onClick={() => isAvailable && canAfford ? research(tech) : null}
                                        className={`tech-card ${isResearched ? 'researched' : 'available'} ${!isResearched && canAfford ? 'affordable' : !isResearched ? 'unaffordable' : ''}`}>
                                        <div className="tech-header">
                                            <h3 className={`tech-name ${isResearched ? 'researched' : 'available'}`}>{tech.name}</h3>
                                            {isResearched ? <Zap size={16} className="tech-icon researched" /> : <FlaskConical size={16} className="tech-icon available" />}
                                        </div>
                                        <p className="tech-desc">{tech.desc}</p>
                                        {!isResearched && (
                                            <div className={`tech-cost ${canAfford ? 'affordable' : 'unaffordable'}`}>
                                                í•„ìš” ê³¼í•™: {tech.cost.toLocaleString()}
                                            </div>
                                        )}
                                    </div>
                                );
                            })}
                            {researched.length === TECH_TREE.length && <div className="tech-complete-msg">ëª¨ë“  ê¸°ìˆ ì„ ì—°êµ¬í–ˆìŠµë‹ˆë‹¤.</div>}
                        </div>
                    </div>
                </div>
            </div>
        </div>
    );
}

const root = ReactDOM.createRoot(document.getElementById('root'));
root.render(<App />);
